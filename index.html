<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Studio 3.7 - Responsive Export</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --primary: #003366;
      --accent: #FFD700;
      --bg-color: #F3F4F6;
      --panel-bg: #FFFFFF;
      --border: #E5E7EB;
      --text-main: #1F2937;
      --text-sec: #6B7280;
      
      /* Social Colors */
      --fb-color: #1877F2;
      --li-color: #0A66C2;
      --ig-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      --x-color: #000000;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      overflow: hidden; 
    }

    /* --- LAYOUT --- */
    .app-container { display: flex; width: 100%; height: 100%; }

    /* --- SIDEBAR (EDITOR) --- */
    .editor-panel {
      width: 450px;
      background: var(--panel-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      z-index: 10;
      box-shadow: 4px 0 24px rgba(0,0,0,0.05);
    }

    .editor-header { padding: 20px; border-bottom: 1px solid var(--border); background: white; }
    .brand-title { color: var(--primary); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .brand-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; display: inline-block; }

    .editor-scroll { flex: 1; overflow-y: auto; padding: 20px; }

    .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sec); font-weight: 600; margin: 25px 0 10px 0; border-top: 1px solid #eee; padding-top: 20px; }
    .section-label:first-child { margin-top: 0; border-top: none; padding-top: 0; }

    /* Inputs Moderni */
    .input-group { margin-bottom: 20px; }
    .input-group label { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 500; margin-bottom: 6px; }
    
    .form-input, .form-textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; font-size: 0.95rem; transition: all 0.2s;
    }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }

    .helper-link { font-size: 0.8rem; color: var(--primary); text-decoration: underline; cursor: pointer; margin-top: 5px; display: inline-block; }
    .helper-link:hover { color: var(--accent); }

    /* File Upload Moderno */
    .file-drop {
      border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center;
      cursor: pointer; transition: all 0.2s; background: #FAFAFA; position: relative;
    }
    .file-drop:hover { border-color: var(--primary); background: #F0F7FF; }
    .file-drop input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
    .file-preview-mini { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin: 0 auto 5px auto; display: block; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* Tabs News */
    .news-selector { display: flex; gap: 5px; background: #f1f1f1; padding: 4px; border-radius: 8px; margin-bottom: 20px; }
    .news-tab { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); border-radius: 6px; cursor: pointer; }
    .news-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* Checkbox Group for Export */
    .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; }
    .checkbox-item input { accent-color: var(--primary); width: 16px; height: 16px; }

    /* Action Buttons */
    .editor-footer { padding: 20px; border-top: 1px solid var(--border); background: white; display: flex; gap: 10px; flex-wrap: wrap;}
    .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: transform 0.1s; flex: 1; text-align: center;}
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-dark { background: #333; color: white; }
    .btn-success { background: #10B981; color: white; }
    .btn-full { width: 100%; margin-top: 10px; }

    /* --- PREVIEW AREA (RIGHT) --- */
    .preview-panel {
      flex: 1; background-color: var(--bg-color);
      background-image: radial-gradient(#E5E7EB 1px, transparent 1px); background-size: 20px 20px;
      display: flex; flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;
    }

    .platform-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
    .platform-btn {
      background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: 50px;
      font-weight: 600; color: var(--text-sec); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;
    }
    .platform-btn.active { color: white; border-color: transparent; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .platform-btn.fb.active { background: var(--fb-color); }
    .platform-btn.li.active { background: var(--li-color); }
    .platform-btn.ig.active { background: var(--ig-gradient); }
    .platform-btn.x.active { background: var(--x-color); }

    /* --- MOCKUP CARDS --- */
    .mockup-wrapper { width: 500px; max-width: 100%; perspective: 1000px; }
    
    .social-card {
      background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: none; border: 1px solid rgba(0,0,0,0.05);
      text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .social-card.active { display: block; }

    /* --- SOCIAL SPECIFIC STYLES --- */
    .sc-header { padding: 12px 16px; display: flex; align-items: flex-start; gap: 10px; position: relative; }
    .sc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); }
    .sc-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .sc-name { font-weight: 700; font-size: 0.95rem; line-height: 1.2; color: #000000; display: flex; align-items: center; gap: 4px; }
    .sc-meta { font-size: 0.8rem; color: #65676B; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
    .sc-icon-verified { width: 15px; height: 15px; } 
    .sc-more { margin-left: auto; color: #606770; cursor: pointer; }

    .sc-text { padding: 0 16px 12px 16px; font-size: 0.93rem; color: #050505; white-space: pre-wrap; line-height: 1.35; letter-spacing: normal; font-variant-ligatures: none; }
    .sc-text span.link { color: #1877F2; cursor: pointer; }
    .sc-image-container { width: 100%; background: #f0f2f5; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sc-image { width: 100%; height: auto; display: block; }
    
    .sc-footer { padding: 8px 16px; border-top: 1px solid #eee; }
    .sc-actions { display: flex; justify-content: space-between; align-items: center; color: #65676B; font-weight: 600; font-size: 0.9rem; }
    .action-item { display: flex; align-items: center; gap: 6px; padding: 6px 0; }
    
    .card-facebook { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; }
    .card-facebook .sc-name { color: #050505; }
    .card-facebook .sc-text { padding-top: 4px; }
    .fb-stats { padding: 10px 16px; display: flex; justify-content: space-between; font-size: 0.85rem; color: #65676B; border-bottom: 1px solid #dadde1; }
    
    .card-linkedin { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; border-radius: 8px; }
    .card-linkedin .sc-name { font-size: 0.9rem; font-weight: 600; }
    .card-linkedin .sc-meta { font-size: 0.75rem; }
    .card-linkedin .sc-text { font-size: 0.9rem; padding-bottom: 8px; }
    
    .card-instagram { border-radius: 3px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .card-instagram .sc-header { align-items: center; padding: 14px 16px; }
    .card-instagram .sc-name { font-size: 0.9rem; }
    .card-instagram .sc-avatar { width: 32px; height: 32px; padding: 2px; border: 1px solid #dbdbdb; }
    .card-instagram .sc-text { padding: 12px 16px; font-size: 0.9rem; }
    .ig-actions { padding: 10px 16px 0 16px; display: flex; justify-content: space-between; }
    .ig-icons-left { display: flex; gap: 16px; }
    
    .card-x { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; border-radius: 16px; }
    .card-x .sc-name { font-weight: 700; font-size: 0.95rem; }
    .card-x .sc-handle { font-weight: 400; color: #536471; margin-left: 4px; }
    .card-x .sc-text { font-size: 1rem; padding-bottom: 12px; margin-top: -5px; }
    .card-x .sc-image-container { border-radius: 16px; border: 1px solid #cfd9de; margin: 0 16px 16px 16px; width: auto; overflow: hidden; }
    .x-footer { padding: 12px 16px; border-top: 1px solid #eff3f4; display: flex; justify-content: space-between; color: #536471; }
  </style>
</head>
<body>

  <div class="app-container">
    <aside class="editor-panel">
      <div class="editor-header">
        <div class="brand-title"><span class="brand-dot"></span> Social Studio 3.7</div>
      </div>

      <div class="editor-scroll">
        
        <div class="section-label">Identit√† Pagina (Globale)</div>
        <div class="input-group">
          <label>Logo / Avatar Pagina</label>
          <div class="file-drop" id="avatar-drop">
            <img id="avatar-preview-mini" class="file-preview-mini" src="https://via.placeholder.com/40" style="display:none">
            <input type="file" id="global-avatar" accept="image/*">
            <span class="file-input-text" style="font-size:0.8rem; color:#666">Trascina logo o clicca</span>
          </div>
        </div>
        <div class="input-group">
          <label>Nome Pagina</label>
          <input type="text" class="form-input" id="global-name" placeholder="Es. Poste Italiane" value="Poste Italiane">
        </div>
        <div class="input-group">
          <label>Handle (per X/IG)</label>
          <input type="text" class="form-input" id="global-handle" placeholder="Es. @posteitaliane" value="@posteitaliane">
        </div>

        <div class="section-label">Contenuto Post</div>
        
        <div class="news-selector" id="news-tabs">
          </div>

        <div style="background: #eef2ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c7d2fe;">
            <div style="font-size: 0.8rem; color: var(--primary); font-weight: 600;">Modifica canale: <span id="editor-platform-label">Facebook</span></div>
        </div>

        <div class="input-group">
          <label>
            <span>Testo del Post</span>
            <span id="char-count" style="font-weight:400; color:#999; font-size:0.75rem">0 car.</span>
          </label>
          <textarea class="form-textarea" id="post-text" rows="5" placeholder="Scrivi qui il tuo post..."></textarea>
          <span class="helper-link" onclick="app.copyTextToAll()">Copia questo testo su tutti i canali</span>
        </div>

        <div class="input-group">
          <label>Immagine del Post</label>
          <div class="file-drop" id="image-drop">
             <span class="file-input-text">üìÅ Carica immagine</span>
             <input type="file" id="post-image" accept="image/*">
          </div>
          <span class="helper-link" onclick="app.copyImageToAll()">Usa questa immagine su tutti i canali</span>
        </div>

        <div class="section-label">Gestione Progetto</div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <button class="btn btn-secondary" onclick="app.exportJSON()">üíæ Salva JSON</button>
          <button class="btn btn-secondary" onclick="app.triggerImport()">üìÇ Carica JSON</button>
          <input type="file" id="json-import-input" accept=".json" style="display:none" onchange="app.importJSON(this)">
        </div>

        <div class="section-label">Esportazione Web (HTML)</div>
        <div class="checkbox-group">
          <label class="checkbox-item"><input type="checkbox" id="chk-facebook" checked> Facebook</label>
          <label class="checkbox-item"><input type="checkbox" id="chk-linkedin" checked> LinkedIn</label>
          <label class="checkbox-item"><input type="checkbox" id="chk-x" checked> X (Twitter)</label>
          <label class="checkbox-item"><input type="checkbox" id="chk-instagram" checked> Instagram</label>
        </div>
        <button class="btn btn-success btn-full" onclick="app.exportHTML()">üåê Esporta Pagina HTML</button>

      </div>

      <div class="editor-footer">
        <button class="btn btn-primary" onclick="app.downloadZip()">Scarica Immagini (ZIP)</button>
      </div>
    </aside>

    <main class="preview-panel">
      
      <div class="platform-tabs">
        <button class="platform-btn fb active" onclick="app.setPlatform('facebook')">Facebook</button>
        <button class="platform-btn li" onclick="app.setPlatform('linkedin')">LinkedIn</button>
        <button class="platform-btn x" onclick="app.setPlatform('x')">X</button>
        <button class="platform-btn ig" onclick="app.setPlatform('instagram')">Instagram</button>
      </div>

      <div class="mockup-wrapper">
        <div id="card-facebook" class="social-card card-facebook active">
          <div class="sc-header">
            <img src="https://via.placeholder.com/40" class="sc-avatar global-avatar-img">
            <div class="sc-info"><div class="sc-name"><span class="global-name-text">Page</span><svg class="sc-icon-verified" viewBox="0 0 15 15" fill="none"><path d="M7.5 0C3.35786 0 0 3.35786 0 7.5C0 11.6421 3.35786 15 7.5 15C11.6421 15 15 11.6421 15 7.5C15 3.35786 11.6421 0 7.5 0Z" fill="#1877F2"/><path d="M6.3125 10.4375L3.4375 7.5625L4.3125 6.6875L6.3125 8.6875L10.6875 4.3125L11.5625 5.1875L6.3125 10.4375Z" fill="white"/></svg></div><div class="sc-meta">1 h ¬∑ üåç</div></div><div class="sc-more">‚Ä¢‚Ä¢‚Ä¢</div></div>
          <div class="sc-text news-text">...</div>
          <div class="sc-image-container"><img src="" class="sc-image news-image" style="display:none"></div>
          <div class="fb-stats"><span>üëç 1.2K</span><span>45 commenti</span></div>
          <div class="sc-footer"><div class="sc-actions"><div class="action-item">Mi piace</div><div class="action-item">Commenta</div><div class="action-item">Condividi</div></div></div>
        </div>

        <div id="card-linkedin" class="social-card card-linkedin">
          <div class="sc-header"><img src="https://via.placeholder.com/40" class="sc-avatar global-avatar-img"><div class="sc-info"><div class="sc-name global-name-text">Page</div><div class="sc-meta">Azienda</div><div class="sc-meta">2 ore fa ‚Ä¢ üåê</div></div><div class="sc-more">‚Ä¢‚Ä¢‚Ä¢</div></div>
          <div class="sc-text news-text">...</div>
          <div class="sc-image-container"><img src="" class="sc-image news-image" style="display:none"></div>
          <div class="sc-footer"><div class="sc-actions"><div class="action-item">Consiglia</div><div class="action-item">Commenta</div><div class="action-item">Diffondi</div><div class="action-item">Invia</div></div></div>
        </div>

        <div id="card-x" class="social-card card-x">
          <div class="sc-header"><img src="https://via.placeholder.com/40" class="sc-avatar global-avatar-img"><div class="sc-info" style="flex-direction:row; align-items:center;"><div class="sc-name global-name-text">Page</div><div class="sc-handle global-handle-text">@handle</div><div class="sc-meta" style="margin-left:4px">¬∑ 2h</div></div><div class="sc-more">‚Ä¢‚Ä¢‚Ä¢</div></div>
          <div class="sc-text news-text" style="padding: 0 16px 8px 60px; margin-top: -15px;">...</div>
          <div class="sc-image-container" style="margin-left: 60px; width: calc(100% - 76px);"><img src="" class="sc-image news-image" style="display:none"></div>
          <div class="x-footer" style="padding-left: 60px;"><span>üí¨ 24</span><span>RT 120</span><span>‚ô° 890</span></div>
        </div>

        <div id="card-instagram" class="social-card card-instagram">
          <div class="sc-header"><img src="https://via.placeholder.com/40" class="sc-avatar global-avatar-img"><div class="sc-info"><div class="sc-name global-name-text">Page</div></div><div class="sc-more">‚Ä¢‚Ä¢‚Ä¢</div></div>
          <div class="sc-image-container"><img src="" class="sc-image news-image" style="display:none"></div>
          <div class="ig-actions"><div class="ig-icons-left"><span>‚ô°</span><span>üí¨</span><span>‚úàÔ∏è</span></div><div>üîñ</div></div>
          <div style="padding: 0 16px; font-weight:600; font-size:0.9rem; margin-top:8px;">1.234 "Mi piace"</div>
          <div class="sc-text news-text">...</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const CONFIG = {
      maxNews: 5,
      defaultAvatar: 'https://via.placeholder.com/40?text=Logo',
      platforms: ['facebook', 'linkedin', 'x', 'instagram']
    };

    const app = {
      state: {
        activeNews: 1,
        activePlatform: 'facebook',
        global: { name: 'Poste Italiane', handle: '@posteitaliane', avatar: null },
        news: {} 
      },

      init: function() {
        this.renderTabs();
        this.loadState();
        this.bindEvents();
        this.updateUI();
      },

      renderTabs: function() {
        const container = document.getElementById('news-tabs');
        container.innerHTML = '';
        for(let i=1; i<=CONFIG.maxNews; i++) {
          const btn = document.createElement('button');
          btn.className = `news-tab ${i===1 ? 'active' : ''}`;
          btn.innerText = `News ${i}`;
          btn.onclick = () => this.switchNews(i);
          container.appendChild(btn);
        }
      },

      bindEvents: function() {
        document.getElementById('global-name').addEventListener('input', (e) => { this.state.global.name = e.target.value; this.updatePreviewGlobal(); this.saveState(); });
        document.getElementById('global-handle').addEventListener('input', (e) => { this.state.global.handle = e.target.value; this.updatePreviewGlobal(); this.saveState(); });
        
        const avDrop = document.getElementById('avatar-drop');
        const avInput = document.getElementById('global-avatar');
        avInput.addEventListener('change', (e) => this.handleAvatarUpload(e.target.files[0]));
        avDrop.addEventListener('click', () => avInput.click());
        avDrop.addEventListener('dragover', (e) => { e.preventDefault(); avDrop.style.background = '#e6f7ff'; });
        avDrop.addEventListener('drop', (e) => { e.preventDefault(); this.handleAvatarUpload(e.dataTransfer.files[0]); });

        document.getElementById('post-text').addEventListener('input', (e) => {
          const content = this.getCurrentContent();
          content.text = e.target.value;
          document.getElementById('char-count').innerText = `${e.target.value.length} car.`;
          this.updatePreviewContent();
          this.saveState();
        });

        const imgDrop = document.getElementById('image-drop');
        const imgInput = document.getElementById('post-image');
        imgInput.addEventListener('change', (e) => this.handleImageUpload(e.target.files[0]));
        imgDrop.addEventListener('click', () => imgInput.click());
        imgDrop.addEventListener('dragover', (e) => { e.preventDefault(); imgDrop.style.background = '#e6f7ff'; });
        imgDrop.addEventListener('drop', (e) => { e.preventDefault(); this.handleImageUpload(e.dataTransfer.files[0]); });
      },

      getCurrentContent: function() {
        if(!this.state.news[this.state.activeNews]) this.state.news[this.state.activeNews] = {};
        if(!this.state.news[this.state.activeNews][this.state.activePlatform]) this.state.news[this.state.activeNews][this.state.activePlatform] = { text: '', img: null };
        return this.state.news[this.state.activeNews][this.state.activePlatform];
      },

      switchNews: function(id) {
        this.state.activeNews = id;
        document.querySelectorAll('.news-tab').forEach((b, idx) => b.classList.toggle('active', (idx + 1) === id));
        this.refreshEditorInputs();
        this.updatePreviewContent();
      },

      setPlatform: function(id) {
        this.state.activePlatform = id;
        document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.platform-btn.${id === 'facebook' ? 'fb' : id === 'linkedin' ? 'li' : id === 'instagram' ? 'ig' : 'x'}`).classList.add('active');
        document.querySelectorAll('.social-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`card-${id}`).classList.add('active');
        this.refreshEditorInputs();
        this.updatePreviewContent();
      },

      refreshEditorInputs: function() {
        const data = this.getCurrentContent();
        document.getElementById('editor-platform-label').innerText = this.state.activePlatform.charAt(0).toUpperCase() + this.state.activePlatform.slice(1);
        document.getElementById('post-text').value = data.text || '';
        document.getElementById('char-count').innerText = `${(data.text || '').length} car.`;
        document.querySelector('#image-drop .file-input-text').innerText = data.img ? 'üì∑ Immagine pronta' : 'üìÅ Carica immagine';
      },

      handleAvatarUpload: function(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          this.state.global.avatar = e.target.result;
          this.updatePreviewGlobal();
          this.saveState();
          document.getElementById('avatar-preview-mini').src = e.target.result;
          document.getElementById('avatar-preview-mini').style.display = 'block';
        };
        reader.readAsDataURL(file);
      },

      handleImageUpload: function(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          this.getCurrentContent().img = e.target.result;
          document.querySelector('#image-drop .file-input-text').innerText = `üì∑ ${file.name}`;
          this.updatePreviewContent();
          this.saveState();
        };
        reader.readAsDataURL(file);
      },

      copyTextToAll: function() {
        const txt = this.getCurrentContent().text;
        if(!txt) return;
        CONFIG.platforms.forEach(p => {
            if(!this.state.news[this.state.activeNews][p]) this.state.news[this.state.activeNews][p] = {};
            this.state.news[this.state.activeNews][p].text = txt;
        });
        alert('Testo copiato su tutti i canali!');
        this.saveState();
      },

      copyImageToAll: function() {
        const img = this.getCurrentContent().img;
        if(!img) return;
        CONFIG.platforms.forEach(p => {
            if(!this.state.news[this.state.activeNews][p]) this.state.news[this.state.activeNews][p] = {};
            this.state.news[this.state.activeNews][p].img = img;
        });
        alert('Immagine applicata a tutti i canali!');
        this.saveState();
      },

      formatText: function(text) {
        if(!text) return '';
        return text.replace(/(#[\w\d]+|@[\w\d]+|https?:\/\/\S+)/g, '<span class="link">$1</span>');
      },

      updatePreviewGlobal: function() {
        document.querySelectorAll('.global-name-text').forEach(el => el.innerText = this.state.global.name);
        document.querySelectorAll('.global-handle-text').forEach(el => el.innerText = this.state.global.handle);
        document.querySelectorAll('.global-avatar-img').forEach(el => el.src = this.state.global.avatar || CONFIG.defaultAvatar);
      },

      updatePreviewContent: function() {
        const data = this.getCurrentContent();
        document.querySelector(`#card-${this.state.activePlatform} .news-text`).innerHTML = this.formatText(data.text);
        const imgEl = document.querySelector(`#card-${this.state.activePlatform} .news-image`);
        imgEl.src = data.img || '';
        imgEl.style.display = data.img ? 'block' : 'none';
      },

      updateUI: function() {
        document.getElementById('global-name').value = this.state.global.name;
        document.getElementById('global-handle').value = this.state.global.handle;
        if(this.state.global.avatar) {
          const mini = document.getElementById('avatar-preview-mini');
          mini.src = this.state.global.avatar;
          mini.style.display = 'block';
        }
        this.switchNews(this.state.activeNews);
        this.setPlatform(this.state.activePlatform);
        this.updatePreviewGlobal();
      },

      saveState: function() { localStorage.setItem('socialStudioStateV3_5', JSON.stringify(this.state)); },
      loadState: function() {
        const saved = localStorage.getItem('socialStudioStateV3_5');
        if(saved) try { this.state = { ...this.state, ...JSON.parse(saved) }; } catch(e) {}
      },

      // --- JSON Project Management ---
      exportJSON: function() {
        const blob = new Blob([JSON.stringify(this.state)], {type: "application/json"});
        saveAs(blob, `SocialStudio_Project_News${this.state.activeNews}.json`);
      },

      triggerImport: function() { document.getElementById('json-import-input').click(); },

      importJSON: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            this.state = JSON.parse(e.target.result);
            this.updateUI();
            alert("Progetto caricato correttamente!");
          } catch(err) { alert("Errore nel file JSON"); }
        };
        reader.readAsText(file);
      },

      // --- Improved HTML Export ---
      exportHTML: function() {
        const platforms = ['facebook', 'linkedin', 'x', 'instagram'];
        const selected = platforms.filter(p => document.getElementById(`chk-${p}`).checked);
        
        if(selected.length === 0) { alert("Seleziona almeno un canale"); return; }

        let gridContent = '';
        const currentP = this.state.activePlatform;

        selected.forEach(p => {
          this.setPlatform(p);
          const cardEl = document.getElementById(`card-${p}`);
          const clone = cardEl.cloneNode(true);
          
          // Make sure image renders correctly if hidden
          const img = clone.querySelector('.news-image');
          if(img.getAttribute('src') === '') img.style.display = 'none';

          // Force layout properties for export
          clone.style.display = 'block';
          clone.style.width = '100%';
          clone.style.maxWidth = '500px'; 
          
          // Badge colors
          let badgeColor = '#333';
          if(p==='facebook') badgeColor = '#1877F2';
          if(p==='linkedin') badgeColor = '#0A66C2';
          if(p==='instagram') badgeColor = 'linear-gradient(45deg, #f09433 0%, #dc2743 100%)';
          
          const labelName = p === 'x' ? 'X (Twitter)' : p.charAt(0).toUpperCase() + p.slice(1);

          gridContent += `
            <div class="mockup-item">
               <div class="platform-badge" style="background:${badgeColor}">${labelName}</div>
               ${clone.outerHTML}
            </div>
          `;
        });

        this.setPlatform(currentP); // Restore app state

        const css = document.getElementsByTagName('style')[0].innerHTML;
        const htmlContent = `
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anteprima Social</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  ${css}
  /* EXPORT SPECIFIC STYLES */
  body { background: #f0f2f5; font-family: 'Inter', sans-serif; display:block; overflow-y:scroll; padding:0; margin:0;}
  .main-export-container { max-width: 1100px; margin: 40px auto; padding: 20px; }
  h1 { text-align:center; color:#333; margin-bottom:40px; }
  
  /* GRID LAYOUT FOR EXPORT */
  .mockup-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 40px;
    justify-items: center;
  }
  
  .mockup-item {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .platform-badge {
    padding: 6px 16px;
    border-radius: 20px;
    color: white;
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .social-card { 
    animation: none !important; 
    opacity: 1 !important; 
    transform: none !important; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    /* Essential for mobile responsive */
    width: 100% !important;
    max-width: 500px !important;
  }

  /* MOBILE SPECIFIC OVERRIDE */
  @media (max-width: 768px) {
    .mockup-grid {
        grid-template-columns: 1fr; /* Stack vertically */
        gap: 30px;
    }
    .main-export-container { padding: 15px; margin: 0; }
  }
</style>
</head>
<body>
  <div class="main-export-container">
    <h1>Anteprima Social</h1>
    <div class="mockup-grid">
      ${gridContent}
    </div>
  </div>
</body>
</html>`;

        const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
        saveAs(blob, `Mockup_Anteprima.html`);
      },

      downloadZip: function() {
        const zip = new JSZip();
        const nid = this.state.activeNews;
        const cp = this.state.activePlatform;
        const folder = zip.folder(`assets_News${nid}`);
        const nData = this.state.news[nid] || {};

        CONFIG.platforms.forEach(p => {
          if(nData[p]?.text) folder.file(`${p}_copy.txt`, nData[p].text);
          if(nData[p]?.img) folder.file(`${p}_image.png`, this.dataURItoBlob(nData[p].img));
        });

        const process = async (idx) => {
          if(idx >= CONFIG.platforms.length) {
            this.setPlatform(cp);
            saveAs(await zip.generateAsync({type:"blob"}), `SocialMockups_News${nid}.zip`);
            return;
          }
          const p = CONFIG.platforms[idx];
          this.setPlatform(p);
          await document.fonts.ready;
          await new Promise(r=>setTimeout(r,100));
          const canvas = await html2canvas(document.getElementById(`card-${p}`), {scale:2, useCORS:true});
          canvas.toBlob(blob => { zip.file(`Mockup_${p}.png`, blob); process(idx+1); });
        };
        process(0);
      },

      dataURItoBlob: function(dataURI) {
        var byteString = atob(dataURI.split(',')[1]);
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        var ab = new ArrayBuffer(byteString.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
        return new Blob([ab], {type: mimeString});
      }
    };

    window.onload = () => app.init();
  </script>
</body>
</html>
