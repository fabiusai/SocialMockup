<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Studio 6.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style id="main-styles">
    :root {
      --primary: #003366;
      --accent: #FFD700;
      --bg-color: #F3F4F6;
      --panel-bg: #FFFFFF;
      --border: #E5E7EB;
      --text-main: #1F2937;
      --text-sec: #65676B;
      --fb-color: #1877F2;
      --li-color: #0A66C2;
      --ig-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: "Segoe UI Historic", "Segoe UI", Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      overflow: hidden; 
    }

    .app-container { display: flex; width: 100%; height: 100%; }

    /* --- SIDEBAR & ACCORDIONS --- */
    .editor-panel {
      width: 420px;
      background: var(--panel-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      z-index: 10;
      box-shadow: 4px 0 24px rgba(0,0,0,0.05);
    }

    .editor-header { padding: 20px; border-bottom: 1px solid var(--border); background: white; }
    .brand-title { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
    .brand-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; }

    .editor-scroll { flex: 1; overflow-y: auto; }

    .accordion-item { border-bottom: 1px solid var(--border); }
    .accordion-header {
      width: 100%; padding: 16px 20px; background: #fff; border: none;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; font-weight: 700; font-size: 0.8rem; color: var(--primary);
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .accordion-header:hover { background: #f9fafb; }
    .accordion-header::after { content: '‚ñæ'; font-size: 1.1rem; transition: transform 0.3s; }
    .accordion-item.active .accordion-header::after { transform: rotate(180deg); }
    .accordion-content { display: none; padding: 20px; background: #fff; }
    .accordion-item.active .accordion-content { display: block; }

    /* INPUTS & HELPERS */
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
    .form-input, .form-textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-family: inherit; font-size: 0.9rem;
    }
    .helper-link { font-size: 0.75rem; color: var(--fb-color); text-decoration: underline; cursor: pointer; margin-top: 5px; display: inline-block; font-weight: 500; }
    .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer; }

    /* STILI AGGIUNTIVI PER IL "BISCOTTO" EDIT */
    .editor-badge {
        background: #eef2ff; padding: 10px; border-radius: 8px; margin-bottom: 12px;
        font-size: 0.75rem; font-weight: 700; color: var(--primary);
        display: flex; justify-content: space-between; align-items: center;
    }
    .copy-mini-btn {
        background: transparent; border: 1px solid #c7d2fe; border-radius: 4px;
        cursor: pointer; padding: 2px 6px; font-size: 1rem;
        transition: all 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .copy-mini-btn:hover { background: #dbeafe; }
    .copy-mini-btn:active { transform: scale(0.95); }

    .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; text-align: center; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-success { background: #10B981; color: white; }
    .btn-danger-outline { background: white; border: 1px solid #ef4444; color: #ef4444; }
    .btn-full { width: 100%; }

    /* --- PREVIEW PANEL --- */
    .preview-panel {
      flex: 1; background-color: var(--bg-color);
      background-image: radial-gradient(#E5E7EB 1px, transparent 1px); background-size: 20px 20px;
      display: flex; flex-direction: column; align-items: center; padding: 40px; overflow-y: auto;
    }

    .platform-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
    .platform-btn {
      background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: 50px;
      font-weight: 600; color: var(--text-sec); cursor: pointer;
    }
    .platform-btn.active { color: white; border-color: transparent; }
    .platform-btn.fb.active { background: var(--fb-color); }
    .platform-btn.li.active { background: var(--li-color); }
    .platform-btn.ig.active { background: var(--ig-gradient); }
    .platform-btn.x.active { background: #000; }

    .mockup-wrapper { width: 500px; max-width: 100%; }
    
    .social-card {
      background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden; display: none; border: 1px solid rgba(0,0,0,0.05);
      font-family: "Segoe UI Historic", "Segoe UI", Helvetica, Arial, sans-serif;
    }
    .social-card.active { display: block; }

    /* MOCKUP ELEMENTS */
    .sc-header { padding: 12px 16px; display: flex; align-items: flex-start; gap: 10px; }
    .sc-avatar-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; }
    .sc-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .avatar-collab-1 { width: 28px; height: 28px; border-radius: 50%; position: absolute; top: 0; left: 0; z-index: 2; border: 2px solid white; display: none; object-fit: cover; }
    .avatar-collab-2 { width: 28px; height: 28px; border-radius: 50%; position: absolute; bottom: 0; right: 0; z-index: 1; border: 2px solid white; display: none; object-fit: cover; }
    .is-collab .sc-avatar { display: none; }
    .is-collab .avatar-collab-1, .is-collab .avatar-collab-2 { display: block; }

    .sc-name { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; line-height: 1.2; }
    .conjunction { font-weight: 400; color: #65676B; }
    .sc-icon-verified { width: 16px; height: 16px; display: none; }
    .verified-active { display: inline-block; }
    .sc-meta { font-size: 0.8rem; color: #65676B; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
    .fb-world-icon { width: 12px; height: 12px; filter: grayscale(1); opacity: 0.6; }

    .sc-text { padding: 4px 16px 12px; font-size: 15px; line-height: 1.3333; color: #050505; white-space: pre-wrap; }
    .sc-image-container { width: 100%; background: #f0f2f5; min-height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sc-image { width: 100%; display: block; }

    /* FOOTER ICONS */
    .sc-footer { border-top: 1px solid #eee; }
    .sc-actions { display: flex; justify-content: space-around; padding: 4px 0; }
    .action-item { display: flex; align-items: center; gap: 8px; padding: 10px; color: #65676B; font-weight: 600; font-size: 0.9rem; }
    .action-icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }

    .card-instagram .sc-avatar-container { width: 32px; height: 32px; }
    .card-instagram .avatar-collab-1, .card-instagram .avatar-collab-2 { width: 22px; height: 22px; }

    .news-selector { display: flex; gap: 4px; background: #f1f1f1; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
    .news-tab { flex: 1; border: none; background: transparent; padding: 6px; font-size: 0.75rem; font-weight: 600; border-radius: 6px; cursor: pointer; color: var(--text-sec); }
    .news-tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  </style>
</head>
<body>

  <div class="app-container">
    <aside class="editor-panel">
      <div class="editor-header"><div class="brand-title"><span class="brand-dot"></span> Social Studio 6.0</div></div>
      <div class="editor-scroll">
        
        <div class="accordion-item active">
          <button class="accordion-header" onclick="app.toggleAccordion(this)">1. Profilo Pagina</button>
          <div class="accordion-content">
            <div class="input-group"><label>Logo / Avatar</label><input type="file" id="global-avatar" accept="image/*" class="form-input"></div>
            <div class="input-group"><label>Nome Pagina</label><input type="text" id="global-name" class="form-input" value="Nome Pagina"></div>
            <div class="input-group"><label>Handle (@username)</label><input type="text" id="global-handle" class="form-input" value="@nomepagina"></div>
            <label class="checkbox-item"><input type="checkbox" id="main-verified" checked> Badge Verificato</label>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" onclick="app.toggleAccordion(this)">2. Collaborazione</button>
          <div class="accordion-content">
            <label class="checkbox-item" style="margin-bottom:15px"><input type="checkbox" id="collab-active"> Attiva Collab (FB/IG)</label>
            <div id="collab-fields" style="display:none; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                <div class="input-group"><label>Logo Partner</label><input type="file" id="collab-avatar" accept="image/*" class="form-input"></div>
                <div class="input-group"><input type="text" id="collab-name" class="form-input" placeholder="Partner" value="Partner"></div>
                <div class="input-group"><input type="text" id="collab-handle" class="form-input" placeholder="@partner" value="@partner"></div>
                <label class="checkbox-item"><input type="checkbox" id="collab-verified" checked> Partner Verificato</label>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" onclick="app.toggleAccordion(this)">3. Editor Contenuto</button>
          <div class="accordion-content">
            <div class="news-selector" id="news-tabs"></div>
            
            <div class="editor-badge">
                <span>Modifica: <span id="editor-platform-label">FACEBOOK</span></span>
                <button class="copy-mini-btn" onclick="app.copyCurrentText(this)" title="Copia testo negli appunti">üìã</button>
            </div>
            
            <div class="input-group">
                <label>Testo del Post</label>
                <textarea class="form-textarea" id="post-text" rows="5"></textarea>
                <span class="helper-link" onclick="app.copyTextToAll()">Copia questo testo su tutti i canali</span>
            </div>
            
            <div class="input-group">
                <label>Immagine Post</label>
                <input type="file" id="post-image" accept="image/*" class="form-input">
                <span class="helper-link" onclick="app.copyImageToAll()">Applica immagine a tutti i canali</span>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" onclick="app.toggleAccordion(this)">4. Esportazione</button>
          <div class="accordion-content">
            <div class="input-group">
                <label>Nome File Export</label>
                <input type="text" id="export-filename" class="form-input" value="Progetto" placeholder="Nome progetto...">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" style="flex:1" onclick="app.exportJSON()">üíæ JSON</button>
                <button class="btn btn-secondary" style="flex:1" onclick="app.triggerImport()">üìÇ Carica</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:15px;">
                <label class="checkbox-item"><input type="checkbox" id="chk-facebook" checked> Facebook</label>
                <label class="checkbox-item"><input type="checkbox" id="chk-linkedin" checked> LinkedIn</label>
                <label class="checkbox-item"><input type="checkbox" id="chk-x" checked> X</label>
                <label class="checkbox-item"><input type="checkbox" id="chk-instagram" checked> Instagram</label>
            </div>
            <button class="btn btn-success btn-full" onclick="app.exportHTML()">üåê Esporta Anteprima HTML</button>
            <button class="btn btn-primary btn-full" onclick="app.downloadZip()" style="margin-top:10px">üì¶ Scarica ZIP Mockups</button>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn btn-primary btn-full" id="btn-save-browser" onclick="app.manualSave()" style="margin-bottom:10px; background-color: var(--text-sec);">üíæ Salva nel Browser</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-danger-outline" style="flex:1" onclick="app.resetCurrentPage()">üóëÔ∏è Reset Pagina</button>
                    <button class="btn btn-danger-outline" style="flex:1" onclick="app.resetApp()">üí£ Reset App</button>
                </div>
            </div>
          </div>
        </div>
        <input type="file" id="json-input" style="display:none" onchange="app.importJSON(this)">
      </div>
    </aside>

    <main class="preview-panel">
      <div class="platform-tabs">
        <button class="platform-btn fb active" onclick="app.setPlatform('facebook')">Facebook</button>
        <button class="platform-btn li" onclick="app.setPlatform('linkedin')">LinkedIn</button>
        <button class="platform-btn x" onclick="app.setPlatform('x')">X</button>
        <button class="platform-btn ig" onclick="app.setPlatform('instagram')">Instagram</button>
      </div>

      <div class="mockup-wrapper">
        <div id="card-facebook" class="social-card active">
          <div class="sc-header">
            <div class="sc-avatar-container"><img src="" class="sc-avatar main-avatar-img"><img src="" class="avatar-collab-1 main-avatar-img"><img src="" class="avatar-collab-2 partner-avatar-img"></div>
            <div class="sc-info">
                <div class="sc-name"><span class="n1"></span><svg class="sc-icon-verified main-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#1877F2"/></svg><span class="conj"></span><span class="n2"></span><svg class="sc-icon-verified partner-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#1877F2"/></svg></div>
                <div class="sc-meta">1 h ¬∑ <svg class="fb-world-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
            </div>
          </div>
          <div class="sc-text news-text">...</div>
          <div class="sc-image-container"><img src="" class="sc-image news-image"></div>
          <div class="sc-footer"><div class="sc-actions">
            <div class="action-item"><svg class="action-icon" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>Mi piace</div>
            <div class="action-item"><svg class="action-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>Commenta</div>
            <div class="action-item"><svg class="action-icon" viewBox="0 0 24 24"><path d="M15 8v-5l9 9-9 9v-5c-10 0-14 5-14 5s2-13 14-13z"/></svg>Condividi</div>
          </div></div>
        </div>

        <div id="card-instagram" class="social-card">
            <div class="sc-header"><div class="sc-avatar-container"><img src="" class="sc-avatar main-avatar-img"><img src="" class="avatar-collab-1 main-avatar-img"><img src="" class="avatar-collab-2 partner-avatar-img"></div>
                <div class="sc-info"><div class="sc-name"><span class="n1"></span><svg class="sc-icon-verified main-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#0095f6"/></svg><span class="conj"></span><span class="n2"></span><svg class="sc-icon-verified partner-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#0095f6"/></svg></div></div>
            </div>
            <div class="sc-image-container"><img src="" class="sc-image news-image"></div>
            <div class="sc-text news-text">...</div>
        </div>
        <div id="card-linkedin" class="social-card">
            <div class="sc-header"><div class="sc-avatar-container"><img src="" class="sc-avatar main-avatar-img"></div><div class="sc-info"><div class="sc-name"><span class="n1"></span><svg class="sc-icon-verified main-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#0A66C2"/></svg></div><div class="sc-meta">Azienda ‚Ä¢ 2h ¬∑ üåç</div></div></div>
            <div class="sc-text news-text">...</div>
            <div class="sc-image-container"><img src="" class="sc-image news-image"></div>
        </div>
        <div id="card-x" class="social-card">
            <div class="sc-header"><div class="sc-avatar-container"><img src="" class="sc-avatar main-avatar-img"></div><div class="sc-info"><div class="sc-name"><span class="n1"></span><svg class="sc-icon-verified main-v" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1.9 14.7L6 12.6l1.4-1.4 2.7 2.7 5.9-5.9 1.4 1.4-7.3 7.3z" fill="#000"/></svg></div><div class="sc-meta">19 min</div></div></div>
            <div class="sc-text news-text">...</div>
            <div class="sc-image-container"><img src="" class="sc-image news-image"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const app = {
      state: {
        activeNews: 1, activePlatform: 'facebook',
        global: { name: 'Nome Pagina', handle: '@nomepagina', avatar: null, isVerified: true, collabActive: false, collabName: 'Eni', collabHandle: '@eni', collabAvatar: null, collabVerified: true },
        news: {}
      },

      init() { 
          this.injectResources(); // Inietta HTML e CSS per il video
          this.loadState(); 
          this.renderTabs(); 
          this.bindEvents(); 
          this.updateUI(); 
      },

      // Iniezione dinamica campi Video e CSS per non modificare HTML manualmente
      injectResources() {
          // 1. CSS per il player video
          if (!document.getElementById('video-styles')) {
              const style = document.createElement('style');
              style.id = 'video-styles';
              style.innerHTML = `
                .video-container { position: relative; width: 100%; height: 100%; min-height: 200px; background: #000; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer; }
                .video-cover { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
                .play-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; border: 2px solid white; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
                .play-btn:hover { transform: scale(1.1); background: rgba(200,0,0,0.8); }
                .play-btn::after { content: ''; border-style: solid; border-width: 10px 0 10px 18px; border-color: transparent transparent transparent white; margin-left: 4px; }
                .native-video { width: 100%; height: 100%; object-fit: cover; z-index: 0; }
                .playing .video-cover, .playing .play-btn { display: none; }
                .playing .native-video { z-index: 3; }
              `;
              document.head.appendChild(style);
          }

          // 2. HTML Input Campi Video (dopo l'input immagine)
          const imgGroup = document.querySelector('#post-image') ? document.querySelector('#post-image').closest('.input-group') : null;
          if (imgGroup && !document.getElementById('post-video-url')) {
              const div = document.createElement('div');
              div.innerHTML = `
                <div class="input-group" style="margin-top:15px; padding-top:15px; border-top:1px dashed #E5E7EB;">
                    <label>Video URL (MP4)</label>
                    <input type="text" id="post-video-url" class="form-input" placeholder="https://..." style="margin-bottom:5px;">
                    <span class="helper-link" onclick="app.copyVideoToAll()">Applica video a tutti</span>
                </div>
                <div class="input-group">
                    <label>Cover Video (Opzionale)</label>
                    <input type="file" id="post-video-cover" accept="image/*" class="form-input">
                </div>
              `;
              imgGroup.parentNode.insertBefore(div, imgGroup.nextSibling);
          }
      },

      toggleAccordion(btn) {
        const item = btn.parentElement;
        document.querySelectorAll('.accordion-item').forEach(i => { if(i !== item) i.classList.remove('active'); });
        item.classList.toggle('active');
      },

      renderTabs() {
        const container = document.getElementById('news-tabs'); 
        if(!container) return;
        container.innerHTML = '';
        for(let i=1; i<=5; i++) {
          const btn = document.createElement('button'); btn.className = `news-tab ${i===this.state.activeNews ? 'active' : ''}`;
          btn.innerText = `N${i}`; btn.onclick = () => this.switchNews(i); container.appendChild(btn);
        }
      },

      bindEvents() {
        const listen = (id, key, sub = 'global', isCheck = false) => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener(isCheck ? 'change' : 'input', (e) => {
                this.state[sub][key] = isCheck ? e.target.checked : e.target.value;
                if(id === 'collab-active') document.getElementById('collab-fields').style.display = e.target.checked ? 'block' : 'none';
                this.updateUI(); this.saveState();
            });
        };
        listen('global-name', 'name'); listen('global-handle', 'handle'); listen('main-verified', 'isVerified', 'global', true);
        listen('collab-active', 'collabActive', 'global', true); listen('collab-name', 'collabName'); listen('collab-handle', 'collabHandle'); listen('collab-verified', 'collabVerified', 'global', true);
        
        const txt = document.getElementById('post-text');
        if(txt) txt.addEventListener('input', (e) => { this.getCurrentData().text = e.target.value; this.updatePreviewContent(); this.saveState(); });
        
        // Listener per Video URL - Delega o check esistenza
        const vidUrl = document.getElementById('post-video-url');
        if(vidUrl) vidUrl.addEventListener('input', (e) => {
            this.getCurrentData().videoUrl = e.target.value;
            this.updatePreviewContent(); this.saveState();
        });

        const av = document.getElementById('global-avatar'); if(av) av.onchange = (e) => this.handleFile(e.target.files[0], 'avatar');
        const cv = document.getElementById('collab-avatar'); if(cv) cv.onchange = (e) => this.handleFile(e.target.files[0], 'collabAvatar');
        const pi = document.getElementById('post-image'); if(pi) pi.onchange = (e) => this.handleFile(e.target.files[0], 'postImage');
        
        const pvc = document.getElementById('post-video-cover');
        if(pvc) pvc.onchange = (e) => this.handleFile(e.target.files[0], 'videoCover');
      },

      handleFile(file, type) {
        if(!file) return; const reader = new FileReader();
        reader.onload = (e) => {
            if(type === 'avatar') this.state.global.avatar = e.target.result;
            else if(type === 'collabAvatar') this.state.global.collabAvatar = e.target.result;
            else if(type === 'videoCover') this.getCurrentData().videoCover = e.target.result;
            else this.getCurrentData().img = e.target.result;
            this.updateUI(); this.saveState();
        };
        reader.readAsDataURL(file);
      },

      getCurrentData() {
        const nid = this.state.activeNews, pid = this.state.activePlatform;
        if(!this.state.news[nid]) this.state.news[nid] = {};
        if(!this.state.news[nid][pid]) this.state.news[nid][pid] = { text: '', img: null, videoUrl: '', videoCover: null };
        return this.state.news[nid][pid];
      },

      updateUI() {
        const g = this.state.global;
        const platLabel = document.getElementById('editor-platform-label');
        if(platLabel) platLabel.innerText = this.state.activePlatform.toUpperCase();
        
        document.querySelectorAll('.social-card').forEach(card => {
            const isCollab = g.collabActive && (card.id === 'card-facebook' || card.id === 'card-instagram');
            const avatarContainer = card.querySelector('.sc-avatar-container');
            if(avatarContainer) avatarContainer.classList.toggle('is-collab', isCollab);
            
            const n1 = card.querySelector('.n1'), n2 = card.querySelector('.n2'), conj = card.querySelector('.conj');
            if(n1) n1.innerText = (card.id === 'card-instagram' || card.id === 'card-x') ? g.handle : g.name;
            
            if(isCollab && n2) {
                conj.innerHTML = `<span class="conjunction">${card.id === 'card-facebook' ? ' con ' : ', '}</span>`;
                n2.innerText = card.id === 'card-facebook' ? g.collabName : g.collabHandle;
                const pv = card.querySelector('.partner-v');
                if(pv) pv.classList.toggle('verified-active', g.collabVerified);
            } else if(n2) { 
                conj.innerText = ''; n2.innerText = ''; 
                const pv = card.querySelector('.partner-v');
                if(pv) pv.classList.remove('verified-active'); 
            }
            const mainV = card.querySelector('.main-v');
            if(mainV) mainV.classList.toggle('verified-active', g.isVerified);
        });
        document.querySelectorAll('.main-avatar-img').forEach(img => img.src = g.avatar || 'https://via.placeholder.com/40');
        document.querySelectorAll('.partner-avatar-img').forEach(img => img.src = g.collabAvatar || 'https://via.placeholder.com/40');
        
        const current = this.getCurrentData();
        const pt = document.getElementById('post-text'); if(pt) pt.value = current.text || '';
        const pvu = document.getElementById('post-video-url'); if(pvu) pvu.value = current.videoUrl || '';
        
        this.updatePreviewContent();
      },

      updatePreviewContent() {
        Object.keys(this.state.news[this.state.activeNews] || {}).forEach(pid => {
            const card = document.getElementById(`card-${pid}`);
            if(card) {
                const data = this.state.news[this.state.activeNews][pid];
                const textEl = card.querySelector('.news-text');
                if(textEl) textEl.innerText = data.text || '';
                
                // LOGICA VIDEO vs IMMAGINE
                const container = card.querySelector('.sc-image-container');
                if(container) {
                    if (data.videoUrl && data.videoUrl.trim() !== '') {
                        // Modo VIDEO
                        const coverSrc = data.videoCover || data.img || 'https://via.placeholder.com/500x300?text=No+Cover';
                        container.innerHTML = `
                            <div class="video-container" onclick="this.classList.add('playing'); this.querySelector('video').play()">
                                <img src="${coverSrc}" class="video-cover">
                                <div class="play-btn"></div>
                                <video src="${data.videoUrl}" class="native-video" playsinline loop controls></video>
                            </div>
                        `;
                    } else {
                        // Modo IMMAGINE STANDARD
                        container.innerHTML = `<img src="${data.img || ''}" class="sc-image news-image">`;
                        const img = container.querySelector('.news-image');
                        if(img) img.style.display = data.img ? 'block' : 'none';
                    }
                }
            }
        });
      },

      copyTextToAll() {
        const txt = this.getCurrentData().text;
        ['facebook','linkedin','x','instagram'].forEach(p => {
            if(!this.state.news[this.state.activeNews][p]) this.state.news[this.state.activeNews][p] = {};
            this.state.news[this.state.activeNews][p].text = txt;
        });
        this.updatePreviewContent(); alert("Testo copiato su tutti i canali!");
      },
      
      copyVideoToAll() {
        const current = this.getCurrentData();
        ['facebook','linkedin','x','instagram'].forEach(p => {
            if(!this.state.news[this.state.activeNews][p]) this.state.news[this.state.activeNews][p] = {};
            this.state.news[this.state.activeNews][p].videoUrl = current.videoUrl;
            this.state.news[this.state.activeNews][p].videoCover = current.videoCover;
        });
        this.updatePreviewContent(); alert("Video e Cover applicati a tutti!");
      },

      copyCurrentText(btn) {
          const text = document.getElementById('post-text').value;
          if(!text) return;
          navigator.clipboard.writeText(text).then(() => {
              const original = btn.innerText;
              btn.innerText = "‚úÖ";
              setTimeout(() => btn.innerText = original, 1500);
          }).catch(err => {
              console.error(err); alert("Errore copia");
          });
      },

      copyImageToAll() {
        const img = this.getCurrentData().img;
        ['facebook','linkedin','x','instagram'].forEach(p => {
            if(!this.state.news[this.state.activeNews][p]) this.state.news[this.state.activeNews][p] = {};
            this.state.news[this.state.activeNews][p].img = img;
        });
        this.updatePreviewContent(); alert("Immagine copiata su tutti i canali!");
      },

      switchNews(id) { this.state.activeNews = id; this.renderTabs(); this.updateUI(); },
      setPlatform(p) {
        this.state.activePlatform = p;
        document.querySelectorAll('.platform-btn').forEach(b => b.classList.toggle('active', b.classList.contains(p.slice(0,2))));
        document.querySelectorAll('.social-card').forEach(c => c.classList.toggle('active', c.id === `card-${p}`));
        this.updateUI();
      },

      getTimestamp() {
        const now = new Date();
        const pad = (n) => n < 10 ? '0' + n : n;
        return `${now.getFullYear()}_${pad(now.getMonth()+1)}_${pad(now.getDate())}_${pad(now.getHours())}_${pad(now.getMinutes())}`;
      },

      exportJSON() {
        const prefix = document.getElementById('export-filename') ? document.getElementById('export-filename').value : 'Progetto';
        const filename = `${prefix}_${this.getTimestamp()}.json`;
        saveAs(new Blob([JSON.stringify(this.state, null, 2)], {type:"application/json"}), filename); 
      },

      manualSave() {
        this.saveState();
        const btn = document.getElementById('btn-save-browser');
        if(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ Salvataggio riuscito!";
            btn.style.background = "#10B981"; 
            btn.style.color = "white";
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = ""; 
                btn.style.color = "";
            }, 2000);
        }
      },

      resetApp() {
        if(!confirm("‚ö†Ô∏è ATTENZIONE: Questa azione canceller√† tutti i dati dell'applicazione. Continuare?")) return;
        localStorage.removeItem('socialStudio_v5_9');
        this.state = {
            activeNews: 1, activePlatform: 'facebook',
            global: { name: 'Nome Pagina', handle: '@nomepagina', avatar: null, isVerified: true, collabActive: false, collabName: 'Eni', collabHandle: '@eni', collabAvatar: null, collabVerified: true },
            news: {}
        };
        const ga = document.getElementById('global-avatar'); if(ga) ga.value = '';
        const ca = document.getElementById('collab-avatar'); if(ca) ca.value = '';
        const pi = document.getElementById('post-image'); if(pi) pi.value = '';
        const pvu = document.getElementById('post-video-url'); if(pvu) pvu.value = ''; 
        const pvc = document.getElementById('post-video-cover'); if(pvc) pvc.value = '';
        this.renderTabs();
        this.updateUI();
      },

      resetCurrentPage() {
        const current = this.state.activeNews;
        if(!confirm(`Vuoi cancellare testi e immagini solo per la Notizia N${current}?`)) return;
        this.state.news[current] = {};
        const pi = document.getElementById('post-image'); if(pi) pi.value = '';
        const pvu = document.getElementById('post-video-url'); if(pvu) pvu.value = '';
        this.updateUI();
        this.saveState();
      },

      triggerImport() { document.getElementById('json-input').click(); },
      importJSON(input) { const r = new FileReader(); r.onload = (e) => { this.state = JSON.parse(e.target.result); this.updateUI(); }; r.readAsText(input.files[0]); },

      exportHTML() {
        const platforms = ['facebook', 'linkedin', 'x', 'instagram'];
        const selected = platforms.filter(p => document.getElementById(`chk-${p}`).checked);
        if(selected.length === 0) { alert("Seleziona canali"); return; }
        let grid = '';
        selected.forEach(p => {
            const card = document.getElementById(`card-${p}`).cloneNode(true);
            card.style.display = 'block'; card.style.width = '100%'; card.style.maxWidth = '500px'; card.style.boxShadow = '0 4px 20px rgba(0,0,0,0.1)';
            let color = p === 'facebook' ? '#1877F2' : p === 'linkedin' ? '#0A66C2' : p === 'instagram' ? 'linear-gradient(45deg, #f09433 0%, #dc2743 100%)' : '#000';
            const label = p === 'x' ? 'X (Twitter)' : p.charAt(0).toUpperCase() + p.slice(1);
            grid += `<div style="display:flex; flex-direction:column; align-items:center;"><div style="background:${color}; color:white; padding:6px 16px; border-radius:20px; font-weight:600; margin-bottom:12px; font-size:0.9rem;">${label}</div>${card.outerHTML}</div>`;
        });
        const styles = document.getElementById('main-styles').innerHTML;
        // Stili video per l'export
        const videoStyles = `.video-container { position: relative; width: 100%; height: 100%; min-height: 200px; background: #000; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer; }
            .video-cover { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
            .play-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2; border: 2px solid white; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
            .play-btn:hover { transform: scale(1.1); background: rgba(200,0,0,0.8); }
            .play-btn::after { content: ''; border-style: solid; border-width: 10px 0 10px 18px; border-color: transparent transparent transparent white; margin-left: 4px; }
            .native-video { width: 100%; height: 100%; object-fit: cover; z-index: 0; }
            .playing .video-cover, .playing .play-btn { display: none; }
            .playing .native-video { z-index: 3; }`;
            
        // NOTA: Qui uso <\/script> con la backslash per evitare di rompere il parser
        const scriptCode = "document.querySelectorAll('.video-container').forEach(v=>v.onclick=function(){this.classList.add('playing');this.querySelector('video').play()})";
        
        const html = `<html><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>${styles} ${videoStyles} body { background:#f0f2f5; font-family:'Inter', sans-serif; padding:40px; } .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 40px; max-width: 1200px; margin: 0 auto; }</style></head><body><div class="grid">${grid}</div><script>${scriptCode}<\/script></body></html>`;
        saveAs(new Blob([html], {type: "text/html"}), `Anteprima_N${this.state.activeNews}.html`);
      },

      async downloadZip() {
        const zip = new JSZip();
        const selected = ['facebook', 'linkedin', 'x', 'instagram'].filter(p => document.getElementById(`chk-${p}`).checked);
        if(selected.length === 0) { alert("Seleziona canali"); return; }
        const cp = this.state.activePlatform;
        for(const p of selected) {
            this.setPlatform(p); await new Promise(r => setTimeout(r, 150));
            const canvas = await html2canvas(document.getElementById(`card-${p}`), {scale:2, useCORS:true, allowTaint: true});
            const blob = await new Promise(r => canvas.toBlob(r));
            zip.file(`${p}.png`, blob);
        }
        this.setPlatform(cp);
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, `Mockups_N${this.state.activeNews}.zip`));
      },

      saveState() { localStorage.setItem('socialStudio_v5_9', JSON.stringify(this.state)); },
      loadState() { const saved = localStorage.getItem('socialStudio_v5_9'); if(saved) this.state = JSON.parse(saved); }
    };
    window.onload = () => app.init();
  </script>
</body>
</html>
